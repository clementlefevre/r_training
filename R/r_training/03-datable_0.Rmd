# Data manipulation - part 1 

To manipulate data with R, there are two options :

- the **dplyr** package. Very beginner friendly, most of the tutorials you can find online are using `dplyr`.
- the **data.table** package is the workhorse of data manipulation in R. For this introduction we will use it, for the following reasons : the syntax is more concise than `dplyr`, and it works seamlessly with large datasets (more than 1 million rows). In comparison, Excel can handle a maximum of 1,048,576 rows.

## Workflow with Excel  {-}
A typical workflow with Excel consists in the following steps :

- load a couple of Excel or csv files,
- filter the tables based on given criteria,
- join the tables (using the  'VLOOKUP' Formula in english, 'SVERWEIS' in German, 'RECHERCHEV' in french)
- select columns of interest
- add new columns such as `=(A1-D4)*24`
- save the output in an other Excel file.
- call it a day.    

```{r excel_meme, echo=FALSE,  fig.cap='', fig.align='center', out.width='50%'}
knitr::include_graphics("images/excel_meme.jfif")
```



When this task occurs once a week, R can help to automatize the so-called "boring stuff" and allows you to spend more time on highly-valuable Teams© meetings.
In this notebook, we are going to achieve all those steps with R.
At the end of this lesson, you will be able to write a script that complete all those tasks automatically.
Bear with me, this is the most complex part of this course, but also the most rewarding.

## Load your data  {-}
Loading your input files in the context of data manipulation means converting them into a a so-called **dataframe**.

A **dataframe** is nothing more than a table, with columns names and rows. That's it.
When loading into R an Excel file, you must beware of :

- the name of the Excel sheet you want to load,
- the index of the row where the column names are located.


*Note : a deeply enshrined pathology with Excel consists in merging the columns cells headers. We will take care of this later in this lesson. We will also punish the culprits.*


First thing first, we load the necessary R packages for this operation : `openxlsx` and `data.table` : 

*don't forget to click on the <span style="color:green;font-size: 24px">**►**</span> button above the code chunk to execute the code.*


```{r}
library(openxlsx)
library(data.table)
```

*Note: If you get an error like : * 

`Error in library(data.table) : there is no package called ‘data.table’`

*don't be scared, it's it perfectly normal, your R Project has not installed this package yet. To solve this, just go to* `Tools -> Install Packages` *and type* **`openxlsx`** (or **`data.table`**) *in the search bar, then click* `install`.
*RStudio will then automatically install the package.*


#### Download the samples files  {-}
Now time to download our input files :


*Note: This operation is only required for this lesson, as later you will use your own files*


```{r eval=FALSE}
# create a new 'data' folder to store the files :
dir.create(file.path("./data"), showWarnings = FALSE)

# download the samples files from the cloud :
download.file("https://r-training-bookdown.s3.amazonaws.com/data/Financial+sample.xlsx", "./data/Financial sample.xlsx", mode = "wb")
download.file("https://r-training-bookdown.s3.amazonaws.com/data/CustomerSupport.csv", "./data/CustomerSupport.csv", mode = "wb")
```
*don't forget to click on the <span style="color:green;font-size: 24px">**►**</span> button above the code chunk to execute the code.*

Have a look in the file explorer, a new **`data`** folder appeared. Click on it, our two sample files should be there.


#### Load the Excel file :  {-} 


*list the names of the sheets that the Excel file contains:*
```{r}
getSheetNames("./data/Financial sample.xlsx")
```
what did we do here ? We read the excel file `Financial sample.xlsx` located in the `data` folder and displayed the names of the sheets contained in this file. Nothing more.
As you can witness with your own eyes, `Financial sample.xlsx` contains two sheets : **Sales** and  **Managers**

*Let’s Just Do It and Be Legends© :  load the* **Sales**  *sheet into a R dataframe :*

```{r}
DT_sales <- read.xlsx("./data/Financial sample.xlsx", sheet = "Sales", detectDates = TRUE)
```

What did we did here ? We just read the content of the **Sales** and loaded into a R table named **DT_sales**.
Check its content by clicking on `DT_sales` in the `Environment` tab in top right area.

## Basic operations  {-}


we begin by looking at the dataframe structure  (`str` is for "structure"):
```{r eval=TRUE}
str(DT_sales)
```
Note: this operation is crucial.

Why ? You can see how R loaded each column and defined a type for each : `chr` for character, `num` for numeric. Oh look, the `Date` column is a `num`.

Let's fix this problem by reloading the Excel with an extra option :
```{r}
DT_sales <- read.xlsx("./data/Financial sample.xlsx", sheet = "Sales", detectDates = TRUE)
```

and here we go :

```{r eval=TRUE}
str(DT_sales)
```

<br />

Excellent, now we want to display the first 10 rows of our `DT_sales` dataframe :

*Note : to display the last 10 rows, just replace `head` with `tail`*
```{r results='hide'}
head(DT_sales)
```



```{r echo=FALSE}
setDT(DT_sales)
library(kableExtra)
kable(head(DT_sales[Product == "Carretera"])) %>%
  kable_styling() %>%
  scroll_box(width = "100%", box_css = "border: 0px;")
```


<br />
How about the list of the **Product** column ?
```{r}
unique(DT_sales$Product)
```

<br />
Show me the max value of the **Profit**  column :
```{r}
max(DT_sales$Profit)
```

<br />



## Quizz {-}

Download the  [**Financial+sample.xlsx** Excel file](https://r-training-bookdown.s3.amazonaws.com/data/Financial+sample.xlsx) and copy it in your RStudio project.
Load this file `openxlsx` into a Dataframe.


<div id="main_Quizz" tabindex=-1>
<div id="Quizz_A1" ></div>
<div id="Answer_A1" class="toggle"><p id="p_Answer_A1">.</p>
```{r eval=TRUE}
    max(mtcars$mpg)
```
</div>
******

<div id="Quizz_A2" ></div>
<div id="Answer_A2" class="toggle"><p id="p_Answer_A2">.</p>
```{r eval=FALSE}
    setdiff(mtcars, mtcars) %>% nrow()
```
</div>
</div>



```{r echo=FALSE}
htmltools::tags$script(src = "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js")
htmltools::tags$script(src = "quizz.json")
htmltools::tags$script(src = "quizz.js")
```

